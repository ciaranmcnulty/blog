<!DOCTYPE html>
<html>
    <head lang="en">
        <title>Home &mdash; Dans Blog &mdash; PHP and other terrible things.</title>
        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
                    <meta name="robots" content="noindex, follow">
                <link href="/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/css/style.css" rel="stylesheet" type="text/css" />

        <link rel="apple-touch-startup-image" href="/images/jackson/2048x2048.png">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="shortcut icon" sizes="76x76" href="/images/jackson/76x76.png">
        <link rel="shortcut icon" sizes="120x120" href="/images/jackson/120x120.png">
        <link rel="shortcut icon" sizes="128x128" href="/images/jackson/128x128.png">
        <link rel="shortcut icon" sizes="152x152" href="/images/jackson/152x152.png">
        <link rel="shortcut icon" sizes="196x196" href="/images/jackson/196x196.png">
        <link rel="shortcut icon" sizes="512x512" href="/images/jackson/512x512.png">
        <link rel="shortcut icon" sizes="1024x1024" href="/images/jackson/1024x1024.png">
        <link rel="shortcut icon" sizes="2048x2048" href="/images/jackson/2048x2048.png">
        <link rel="apple-touch-icon" sizes="76x76" href="/images/jackson/76x76.png">
        <link rel="apple-touch-icon" sizes="120x120" href="/images/jackson/120x120.png">
        <link rel="apple-touch-icon" sizes="128x128" href="/images/jackson/128x128.png">
        <link rel="apple-touch-icon" sizes="152x152" href="/images/jackson/152x152.png">
        <link rel="apple-touch-icon" sizes="196x196" href="/images/jackson/196x196.png">
        <link rel="apple-touch-icon" sizes="512x512" href="/images/jackson/512x512.png">
        <link rel="apple-touch-icon" sizes="1024x1024" href="/images/jackson/1024x1024.png">
        <link rel="apple-touch-icon" sizes="2048x2048" href="/images/jackson/2048x2048.png">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
                               integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
                               crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
                integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
                crossorigin=""></script>

        <link rel="stylesheet" href="/components/highlightjs/styles/github.css" />
        <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Dans Blog activity feed" />
                                    </head>
    <body>
        <header>
            <nav class="navbar navbar-expand-lg">
                <div class="container">
                    <a class="navbar-brand" href="/">Dans Blog</a>
                    <div>
                        <ul class="navbar-nav">
                            <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                            <li class="nav-item"><a class="nav-link" href="/blog">Archive</a></li>
                            <li class="nav-item"><a class="nav-link" href="/touring">Touring</a></li>
                            <li class="nav-item"><a class="nav-link" href="https://read.dantleech.com">Links</a></li>
                                                                                </ul>
                    </div>
                </div>
            </nav>
        </header>
        <main role="main" class="container">
            <div class="row">
                <div class="col-sm-12">
                        <article>
        <header>
            <h2><a href="/blog/2019/06/30/berlin-gartz/">Berlin to Gartz (Meschern)</a></h2>
        </header>
        <div>
            <p>Sitting in a campsite in the sun, in front of reception. Occuping one of 4
tables, each occupied by a single person (three of which are lone cyclists),
mine is the only one in the sun, as I have been in the sun all day I guess it
should make no difference that I spend the time writing this blog sweating and
squinting at my laptop screen.</p>

<p>Was woken from a dream this morning by the sound of a wasp, in the dream, and
on awakening there was indeed a rather large bee flying around my room slowly
clockwise, inspecting everything, and it would only be a matter of time before
it made its way to my bed. Rather than wait for this possiblity, I got out of
bed and opened the window and persuaded the wasp to exit. This was how I was
out of bed at 6am.</p>

<p>I ate breakfast, read the depressing English news, and the even more
depressing global news, and then answered some emails, and did a little bit of
programming, before starting to pack my things.</p>

<p>I had half packed everything over the previous week, and it remained only to
skirmish around the apartment looking for things that I might need. Things I
found: Coffee, Coffee Maker, Socks, Underwear. Things I didn't find: Penknife.
My little €15 Swiss Army knife has been indispensable in previous tours,
fortunately I have an even cheaper multi-tool knife purchased in France almost
10 years ago, it's a bit shit though, so will need to keep an eye out for a
new Swiss Army knife.</p>

<p><img src="/images/tallinn/2019-06-30/zero.JPG" alt="zero" /></p>

<p><em>Mirror</em></p>

<p>After checking everything was turned off, then unplugging everything, I
dragged the bike out into the hallway of the apartment, before I closed the
door I checked to see if I had my key. I didn't, it was on my desk inside the
apartment. After fetching the key and attaching it to my lanyard (used to not
lose my keys) I persuaded my fully-laden and fragile bike to descend the 4
flights of stairs. When I breathlessly arrived at the ground floor, I thought
it would be prudent to ensure that my front door was locked. I ran back up,
and, on the floor, in front of my apartment was my bank card. The same bank
card I had left in England and had resent out to Germany, the bank card that
arrived just last Friday, and that could have delayed my trip. My emergency,
backup, bank card was almost lost in the first 5 minutes of the tour. I
decided to put it somewhere safer. The front door was indeed locked.</p>

<p>The ride out of Berlin was standard, my only training for this tour, over 2
months ago, was a single 100 ride around Brandenburg, which included the
first checkpoint of today's ride: Bernau bei Berlin.</p>

<p><img src="/images/tallinn/2019-06-30/two.JPG" alt="two" /></p>

<p><em>Dashboard</em></p>

<p>A pensioner just sat beside me. He is also from Berlin, and cycled from Berlin
and this is his second stage, he stayed the first night just outside of
Eberswalder (my second checkpoint today), and then cycled here and has been
here for a week.</p>

<p>I stopped after around 45km in Eberswalder, I didn't have much breakfast and
was yearning for a cold drink. It is Sunday, and not many places were open,
but as always there were some Turkish restaurants open, and I stopped at one
and ordered a Falafel Dürum and a cold beer, afterwards I found a bank and got
some emergency Euros -- I would soon be leaving Germany, to Poland which has a
different currency, but Euros are always a good fallback plan.</p>

<p><img src="/images/tallinn/2019-06-30/three.JPG" alt="two" /></p>

<p><em>Falafel and Beer</em></p>

<p>Until 12, and even until 2pm the heat was not too extreme, and I wondered if
this was as bad as it was going to get -- if it got worse I don't know, maybe
it was the prolonged exposure, but soon I became uncomfortable in the heat. I
had plenty of water, but it gets warm, and doesn't deliver the relief that an
ice cold drink can deliver. This is a familiar problem, and I didn't pay it to
much mind, but looked forward to the next place I could get a refreshment.</p>

<p>The route was largely peaceful, and I navigated through quite roads, through
open country, through various small rural towns, with falling-down buildings
and churches.</p>

<p><img src="/images/tallinn/2019-06-30/four.JPG" alt="four" /></p>

<p><em>Canal - aparently there is a cycle path here</em></p>

<p>The bike is holding up after 130km. After the last tour it was in a fragile,
and broken state, I had it repaired, but the mechanic warned me that the frame
(specifically the part of the frame holding the derailleur) isn't as strong as
it used to be after the last accident, I am worried that my gears will start
to slip at some point, but so far the gears are perfect, and the bike is
running almost silently, and in the quiet roads all I can hear is the pleasing
humming of my tyre on the asphalt.</p>

<p>The terrain was mostly flat, and was surprised that I could maintain an
average speed of around 20km per hour, and occasionally make 30km/h on the
flat (perhaps with some wind backing me up).</p>

<p>Physically I feel fine, the last tour found me struggling in damp weather and
bailing out on the first day at around 80km. I did some training 2-3 months
ago, if that can count, by riding 100km. But in any case, today was, in terms
of body mechanics, fine, and I have now only the mild muscle ache which comes
after more-than-average excursion. I see no reason why I shouldn't be able to
do at least another 100km tomorrow.</p>

<p>I stopped three times, first at the Eberswalder for lunch (the Falafel Dürum).
The second time I spotted a pond, and it was hot, and I fancied, for lack of
other options, I could dip my cap into the cold water and cool myself down,
but upon testing the water, it was warm and dirty, and decided to sit down in
the shade for some minutes, study my phone, and hydrate myself with the war
water that I already had.</p>

<p>The next stop was in Gartz, near the Polish border, and only a short ride to
my current location. I spotted a "bier garten", and decided to order a beer.
"Can I order a beer?", "Yes, Naturally". "Then one beer please". Later "Would
you like anything else to drink" "Yes please - water". "What for water?" "Urgh
-- water?" "Yes, but what water? Small, Large" I only wanted tap water, but I
went for the small option. She brought out a small fizzy water, and it cost me
in total €5.60 and she didn't accept the tip. I asked another staff member if
I could ride the path next to the river to the camp site, she said that I
could, and recommended it heartily (the alternative was a diversion on a main
road).</p>

<p><img src="/images/tallinn/2019-06-30/six.JPG" alt="five" /></p>

<p><em>Rock sculpture near the lake at Gartz</em></p>

<p>So here I am in the campsite "Campingplatz Meschern". On arriving I could see
three other cyclists, all three pensioners.</p>

<p>I got a beer and sat down to write this blog, and then was approached by one
of the pensioners who sat down and we had a chat, then another, drunk,
pensioner started conversing with me (well us, but mainly me) "I am pensioner,
I love English pensioners, I was in Spain with English pensioners, we had so
much fun. Not like German pensioners ..." this felt a bit awkward seeing as I
was sitting with a less drunk German pensioner who was showing me the cycle
paths through Brandenberg and Poland. I had the impression that the two
pensioners were not on the best of terms. But I sat and spoke with the two of
them for about an hour or so.</p>

<p>While we were talking about 4 other cyclists came up to the now closed
reception, three from Germany, and one Polish cyclist who spoke neither
English or German.</p>

<p>In summary, nothing bad happened today. I don't seem to be sunburnt (although
my skin is reddening, and although I was wearing socks and sandals (to protect
my white feet), the socks didn't completely cover the "white" area.</p>

<p><img src="/images/tallinn/2019-06-30/seven.JPG" alt="six" /></p>

<p><em>The first 100k</em></p>

<p>When I realised my feet were burning I decided to put on some more appropriate
socks, at which point I dived into my clothes bag, reached down, but didn't
find anything. Emptied the bag, and there were no socks at all. I had
forgotten my sock collection! I discovered that I had plenty of other
underwear however, and boxer-shorts are more valuable than socks -- I only use
socks to protect my feet until they can defend themselves from the heat, and
then I will wear only sandals.</p>

<p><img src="/images/tallinn/2019-06-30/eight.JPG" alt="seven" /></p>

<p><em>Path running next to the Oder river to the campsite</em></p>

<p>I don't feel very hungry, there is a restaurant here, but I might just cook up
some baked beans, and I have some porridge for tomorrow morning.</p>

        </div>
            </article>
    <article>
        <header>
            <h2><a href="/blog/2019/06/12/preparation/">Preparation</a></h2>
        </header>
        <div>
            <p>In two weeks time I'm going to cycle from Berlin to Tallinn.</p>

<p>As with my tour to Norway last year, this is a limited 1 month trip, the plan
is to set off on July 1st, and cycle through Poland, maybe Belarus ,
Lithuania, Latvia, the destination Tallinn, then get the ferry to Helsinki,
Finland in order to get the Ferry back to Rostock, then the train back to
Germany and Berlin.</p>

<p>According to this plan I'll have visited 7 capitals including Berlin.
Previously I have cycled most of the rest of Europe west of Russia, with the
exception of Macedonia, so this will be the north eastern tour. Unfortunately
I certainly won't be able to visit the Ukraine, and Belarus depends.</p>

<p><img src="/images/tallinn/2019-06-12/map.png" alt="Original Plan" /></p>

<p><em>Original Plan</em></p>

<p>Original plan was to cycle directly east from Berlin, through the center of
Poland, through Warsaw, then to Minsk, before turning back up to Vilnius. When
I shared this plan with Polish colleagues, they were keen that I cycle the
north coast, and not the center, as the north coast is apparently great, and
the center not so much. The Belarus Visa sounds like it's non-trivial, so will
see how that evolves.</p>

<p>Now I must ensure that I have the essentials for the journey. The first
essential is the bicycle.</p>

<p>Towards the end of my trip to Norway last year the bike broke down. The
derailleur somehow "fell" into the wheel, and the whole thing crashed apart,
the derailleur was fixed to the steel frame directly and the part of the frame
which held the derailleur was bent inwards, I got it fixed, part of the fixing
involved bending the frame back to where it should have been.</p>

<p><img src="/images/norway/2018-07-11/IMG_20180711_164937.jpg" alt="Something in Norway" /></p>

<p><em>Something in Norway</em></p>

<p>After the quick repair in Norway I got the bicycle repaired "properly" a month
ago, and again the bicycle mechanic had to "bend" the frame back to it's
original position, again.</p>

<p><img src="/images/norway/2018-07-17/IMG_20180717_145347.jpg" alt="Broken Wheel" /></p>

<p><em>When wheels go wrong</em></p>

<p>The entire transmission system was replaced, but the mechanic could give no
certainty that it would last the duration of the trip, and now after commuting
to and from work with the bike, and covering maybe 100k, the gears are
slipping, and, if the frame has started to bend again, well, it won't make it
to Tallinn.</p>

<p>So the first priority is to re-visit the engineer and get his opinion on the
bike. It may be that I can somehow reinforce the frame, otherwise I will need
a new frame, or a new bike. This current bike is around 7 or 8 years old, and
was custom built in Paris for around €1,300, not a huge amount of money, but
probably the single most expensive thing I have ever purchased.</p>

<p>So there's the bike. Then some other fun things -- the tent for example, which
is probably around 5 years old and used on 4 tours. The tent pole has been
broken and repaired several times, maybe it would do to just buy a new pole.
The pole is the main issue.</p>

<ul>
<li>Tent: ragged, tent pole "failed" multiple times.</li>
<li>Handle-bar bag: The bracket mount is broken, any weight pulls the whole
thing down so that it rests on the brake cables only.</li>
<li>Rear light: Need new batteries.</li>
<li>Lock: Lost the key.</li>
<li>Air-mattress: Has a puncture (they <em>always</em> get punctures).</li>
<li>Sleeping bag: fine. I think.</li>
<li>Tyres, breaks: Not good, but can be replaced en-route.</li>
<li>Tools: multi-tool with broken chain tool, need a new chain-tool.</li>
<li>Pump: Shit pump, but it mostly works.</li>
<li>Cooking: Have gas, and pots.</li>
<li>Coffee: Small Italian coffee maker without a handle. Need to choose a tour
mug.</li>
<li>Food bags: yes.</li>
<li>Panniers: 4. The food one has holes.</li>
<li>Socks and underwear: yes.</li>
<li>Other clothes: yes</li>
<li>Navigation: Phone with GPS, phone holder, battery pack. Watch with compass.
Need to find my cycle computer.</li>
<li>Waterproof: Some greasy rain jacket.</li>
<li>Footwear: Sandals, Trainers.</li>
<li>Helmet: Nope.</li>
<li>Photography: My old telephone.</li>
<li>Water: At least one water bottle.</li>
<li>Bungees and straps: Straps yes, at least one bungee cord.</li>
<li>Spares: One spare inner-tube, puncture repair kit, need spare cables.</li>
<li>Training: Commuting ~40-50k a week for 5 months. One 98k ride on a racer a
month or two back.</li>
</ul>

<p>The plan is to do 100k a day, which, judging by last year, where I didn't even
commute to work, could be tricky to start with. On day two or three last year
I had pretty bad knee and arse problems. It started off and got worse, and
worse. I changed my seat height, it go better, then it got worse again, and
again. It got worse, and then it got better, all of a sudden. Then it was
fine. I changed the seat back to the original position and didn't have any
other knee problems for the remaining ~25 days.</p>

<p>If I do 100k a day, then, according to the original Belorussian plan, I would
travel around 1,700k. So as I have a month, that will be just 17 days of
cycling, and 13 days, doing other things. But anything could happen, I could
spend more time in Finland, or I could even make it to Saint-Petersburg.</p>

<p>So, in the next few days I will need to confirm if there is anything wrong
with my bike -- the frame of the bicycle is the least easiest thing to replace
on the road I guess -- all the other missing items can actually be purchased
on the way, although some things are easier to find than others, so I will be
running around Berlin for some things, such as the tent and handle-bar bag.</p>

        </div>
            </article>
    <article>
        <header>
            <h2><a href="/blog/2019/02/11/timesheet-parser-hoa-compiler/">Make Timesheet Parser with Hoa Compiler</a></h2>
        </header>
        <div>
            <p>I have been keeping my timelogs in a plain-text timesheet format as follows:</p>

<pre><code class="bash">2019-02-11
09:00 [JIRA-1234] Adding some functionality
10:00 [standup]
10:15 [JIRA-1234] Fixing that annoying bug
11:00 [JIRA-2134] Review
12:00 [lunch]
13:00 [JIRA-1234] @pairing
14:00 [confused]
18:00 [finish]

2019-02-12
09:00 ...
</code></pre>

<p>Bascially, it's much quick to log my time realistically. I don't need to
continually break my concentration and assign time to tickets as I work on
them, or strain to remember (or make up) what I did at the end of the day, or
even at the end of the week. It also means I can record what <em>really</em>
happened, and not just logging random events on the <code>ZZ-22</code> "catch-all" ticket
where the information is lost to the powers of analysis.</p>

<p>The only problem is that every week I need to translate this into not one but
two JIRAs, this is an operation that involves a huge amount of <em>clicking</em> and
<em>waiting</em> and <em>confusion</em> and <em>ppaaiinn</em>.</p>

<p>So, pain once a week instead of pain every day. But there is no reason that
this situation cannot be ameliorated - we can <em>parse the timesheet</em>. Once we
parse the timesheet we can sync it automatically with JIRA and my Monday
morning trauma is at an end, and our project managers can be happier as I can
accurately curate and log my time every day effortlessly.</p>

<p>And, the miscellaneous tickets can <em>still</em> be assigned to a bucket ticket, but
at least the original information is preserved,</p>

<h2 id="parsing-the-timesheet">Parsing the Timesheet</h2>

<p>Why do we want to parse the timesheet? We want to extract the information from
it, and eventually produce a data structure <em>like</em>:</p>

<pre><code>[
    '2019-01-01' =&gt; [
        'entries' =&gt; [
            [ 'time' =&gt; '10:00', 'category' =&gt; 'AN-1234', 'comment' =&gt; 'foobar' ],
            [ 'time' =&gt; '11:00', 'category' =&gt; 'lunch', 'comment' =&gt; 'foobar' ],
        ]
    ],
    '2019-01-02' =&gt; [
        'entries' =&gt; [
            [ 'time' =&gt; '10:00', 'category' =&gt; 'AN-456', 'comment' =&gt; 'foobar' ],
        ]
    ]
]
</code></pre>

<p>Once we have structured data we can <em>do something useful with it</em>.</p>

<p>We could use regular expressions to extract the data, but, well, it might not end well.
Instead we are going to use a <em>compiler</em> and we are not going to write any PHP
code at all.</p>

<h2 id="the-hoa-compiler">The HOA Compiler</h2>

<p>The <a href="https://github.com/hoaproject/Compiler">HOA
Compiler</a>. The HOA Compiler is an
amazing library which can take a grammar in the form of a <code>.pp</code> file (see
<a href="https://hoa-project.net/En/Literature/Hack/Compiler.html#PP_language">here</a>
for good and detailed documentation).</p>

<p>The timesheet <code>document</code> is composed of one or more <code>date</code> entries (of the
form <code>YYYY-MM-DD</code>) and each date entry consequently contains a list of <code>entry</code>
items, each defining the <code>time</code>, and optionally a <code>category</code>, <code>comment</code> and
one or more <code>tags</code>.</p>

<p>Let's skip straight to it:</p>

<pre><code>%token newline            \n
%token space              \s
%token date               [0-9]{4}-[0-1][0-9]-[0-3][0-9] -&gt; entry

%token entry:time         [0-9]{1,2}:[0-9]{1,2}
%token entry:break        \n\n -&gt; default
%token entry:newline      \n
%token entry:space        \s
%token entry:text         [a-zA-Z0-9'"\h.-]+
%token entry:tag          @[a-zA-Z0-9-_]+
%token entry:bracket_     \[ -&gt; category

%token category:name      [A-Za-z-_0-9]+
%token category:_bracket  \] -&gt; entry

#document:
    date()*

#date:
    &lt;date&gt; &lt;newline&gt;? entry()*

#entry:
    &lt;time&gt; &lt;space&gt;? category()? &lt;space&gt;? &lt;text&gt;? tag()* (&lt;newline&gt; | &lt;break&gt; )?

#category:
    &lt;bracket_&gt; &lt;name&gt; &lt;_bracket&gt;

#tag:
    &lt;space&gt;? &lt;tag&gt;
</code></pre>

<p>So first we have the tokens, which are PCRE (regex) patterns. These define
<em>lexemes</em> the which are like the "atoms" of our grammar. We then define the
<em>rules</em> which combine these atoms - when prefixed with <code>#</code> become <em>nodes</em> in
the AST (more on this later). Note the following:</p>

<ul>
<li>The document has <em>zero or many</em> (<code>*</code>) <code>date()</code> rules.</li>
<li>Each <code>date()</code> rule is composed of a <code>&lt;date&gt;</code> followed by <em>zero or one</em> (<code>?</code>)
newlines, followed by one or many <code>entry()</code> rules.</li>
<li>Each <code>entry()</code> rule must have a valid <code>&lt;time&gt;</code> token, followed by one or zero
spaces, followed by a <code>category()</code> rule, followed by... etc.</li>
</ul>

<p>Did you notice the <code>-&gt;</code> symbols? These are <em>namespace</em> transitions, they mean
that, when encountring a <code>date</code> token the lexer should switch to the <code>date</code>
namespace - and it will then <em>only</em> consider tokens in this namespace, this is
necessary to stop rules conflicting (you don't want to interpret a <code>date</code>
token in a <code>category</code> for example). The Compiler also allows you to transition
to the previous namespace using <code>__shift__</code> (see the
<a href="https://hoa-project.net/En/Literature/Hack/Compiler.html#PP_language">docs</a>
for more info).</p>

<p>When there is no namespace, the <code>default</code> namespace is implicitly used. 
When there is a <code>break</code> token in the <code>date</code> namespace (two new lines as
defined above) we revert back to the <code>default</code> namespace and can consider f.e.
the <code>date</code> token again.</p>

<p>Namespaces are essential, and are what really help make the compiler a much
better option than simple regular expressions.</p>

<p>You may notice that we parse the category as a rule, and the tag as a token.
There is no particular reason for this other than laziness - we could also
have parsed the category as a token, or the tag as a rule, but let's look at
the difference when the AST is rendered:</p>

<p><strong>Tag</strong>:</p>

<pre><code class="bash">#tag
&gt;  token(entry:space,  )
&gt;  token(entry:tag, @barfoo)
</code></pre>

<p><strong>Category</strong>:</p>

<pre><code class="bash">#category
&gt;  token(entry:bracket_, [)
&gt;  token(category:name, AA-1234)
&gt;  token(category:_bracket, ])
</code></pre>

<p>The information we really want from the above two examples is the name -
<code>barfoo</code> and <code>AA-1234</code> respectively. With the category we can easily
extract this information from the token in the AST, but with the tag we need
to perform additional processing (e.g. <code>ltrim('@barfoo', '@')</code>) in order to
obtain the tag name (<code>barfoo</code>), with the category it is less trivial.</p>

<p>But wait, how did we get here?</p>

<h2 id="parsing-the-timesheet">Parsing the Timesheet</h2>

<p>In order to do anything useful, we want to get our hands on an AST (<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">Abstract
Syntax Tree</a>). This will
be the data structure containing all of our data, more-or-less neatly
organized into a tree structure of nodes (remember these are defined in the
grammar with the <code>#</code> prefix, e.g. <code>#entry</code>), each node contains the set of
tokens (and their values) defined in the rule.</p>

<p>We use the HOA Compiler as follows:</p>

<pre><code class="php">use Hoa\Compiler\Llk\Llk;
use Hoa\File\Read;

$compiler = Llk::load(new Read(__DIR__ . '/../../resources/timesheet.pp'));
$ast = $compiler-&gt;parse($string);
// profit!
</code></pre>

<p>Once we have the AST we can visualize it using the <code>Dumper</code> class provided by
HOA:</p>

<pre><code class="php">use Hoa\Compiler\Visitor\Dump;

$dumper = new Dump();
echo $dumper-&gt;visit($ast);
</code></pre>

<p>Producing something like this:</p>

<pre><code class="bash">&gt;  #document                             
&gt;  &gt;  #date                                 
&gt;  &gt;  &gt;  token(date, 2019-01-01)                       
&gt;  &gt;  &gt;  token(entry:newline,             
)                                           
&gt;  &gt;  &gt;  #entry                                                                                                                       
&gt;  &gt;  &gt;  &gt;  token(entry:time, 10:00)   
&gt;  &gt;  &gt;  &gt;  token(entry:space,  )           
&gt;  &gt;  &gt;  &gt;  token(entry:text, Fo)                                                                                                     
&gt;  &gt;  &gt;  &gt;  token(entry:newline,                     
</code></pre>

<h2 id="walking-the-ast">Walking the AST</h2>

<p>The AST variable has type <code>TreeNode</code> and can be traversed easily with helper
methods such as <code>getChildren()</code>, to do something useful with it, you will
probably want to <em>walk the tree</em>, the basic idea is something like the
following:</p>

<pre><code class="php"><br />class TreeWalker
{
    public function walk(TreeNode $node): array
    {
        $dates = [];
        foreach ($node-&gt;getChildren() as $childNode) {
           if ($childNode-&gt;getId() === 'date') {
               $dates[] = $this-&gt;walkDate($childNode);
           }
        }

        return $dates;
    }

    private function walkDate(TreeNode $node): array
    {
        $date = [
            'entries' =&gt; [],
        ];

        foreach ($node-&gt;getChildren() as $childNode) {
            if ($childNode-&gt;getValueToken() === 'date') {
                $date['date'] = new DateTimeImmutable($childNode-&gt;getValueValue()));
            }

            if ($childNode-&gt;getId() == 'entry') {
                $date['entries'][] = $this-&gt;walkEntry($childNode));
            }
        }

        return $date;
    }

    private function walkEntry(TreeNode $node): array
    {
        // etc.
    }
}
</code></pre>

<p>The result would be <em>something</em> like:</p>

<pre><code class="php">[
    'date' =&gt; '2019-21-13',
    'entries' =&gt; [
        [
            // ...
        ],
        [
            // ...
        ]
    ],
    'date' =&gt; '2019-21-14',
    'entries' =&gt; [
        [
            // ...
        ],
        [
            // ...
        ]
    ],
]
</code></pre>

<p>This is a simplified version, see
<a href="https://github.com/dantleech/timekeeper/blob/master/lib/Adapter/Hoa/TimesheetWalker.php">here</a> for the complete version.</p>

<p>Note that we progressively build our data set and extract information from the
tokens in the tree.</p>

<h2 id="summary">Summary</h2>

<p>Now that we have walked the AST we have a data structure suited to our needs,
and the next step is to build some rudimentary reporting and then integrate
with the JIRA API. Along the way the above will probably change significantly -
but fortunately it is now <em>easy</em> to change.</p>

<p>The official documentation provides a much greater depth of knowledge than
this blog post does, but it is perhaps useful to see it explained from a
different perspective.</p>

<p>Here is to great and future hopes of increased productivity powered by
<a href="https://hoa-project.net/En/">HOA</a>.</p>

        </div>
            </article>
    <nav>
        <a href="/page/7">Newer Posts</a><br />
        <a href="/page/9">Older Posts</a><br />
    </nav>
                </div>
            </div>
        </main>
        <footer class="container">
            <div class="text-right">
                <span class="text-muted small">&copy; 2019 Dans Blog powered by electricity, <a class="dull-link" href="https://github.com/sculpin/sculpin">sculpin</a> and possibly other things</span>
            </div>
        </footer>


        <script src="/components/jquery/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
        <script src="/components/bootstrap/js/bootstrap.min.js"></script>
                
                <script src="/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

                    </body>
</html>
